<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cadastro Completo</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">
  <h1>Cadastro de Autor</h1>
  <a href="index.html">← Voltar para lista</a>

  <form id="formCadastro">

    <h2>Autor</h2>
    <label>Nome do Autor</label>
    <input type="text" id="nome_aut" required>

    <label>CPF</label>
    <input type="text" id="cpf_aut" required maxlength="14">

    <label>Data de Nascimento</label>
    <input type="date" id="datanascimento_aut" required>

    <h2>Produtos</h2>
    <div id="produtosContainer"></div>

    <button type="button" id="addProduto">+ Adicionar Produto</button>
    <button type="submit">Cadastrar Tudo</button>
  </form>

  <p id="msg"></p>
</div>

<script>
const produtosContainer = document.getElementById("produtosContainer");
const addProdutoBtn = document.getElementById("addProduto");

function criarProdutoBox() {
  const box = document.createElement("div");
  box.classList.add("produto-box");

  box.innerHTML = `
    <label>Tipo de Produto</label>
    <select class="tipoProduto" required>
      <option value="">Selecione</option>
      <option value="livro">Livro</option>
      <option value="cd">CD</option>
      <option value="dvd">DVD</option>
    </select>

    <label>Título</label>
    <input type="text" class="tituloProduto" required>

    <!-- CAMPOS DE LIVRO -->
<div class="camposLivro" style="display:none;">
  <label>Gênero Literário</label>
  <input type="text" class="generoLivro" name="generoLivro">

  <label>Número de Páginas</label>
  <input type="number" class="paginasLivro" name="paginasLivro">

  <label>Valor</label>
  <input type="text" class="valorProduto" name="valorLivro">
</div>

<!-- CAMPOS DE CD -->
<div class="camposCD" style="display:none;">
  <label>Armazenamento</label>
  <input type="text" class="armazenamentoCD" name="armazenamentoCD">

  <label>Tempo de Vídeo (minutos)</label>
  <input type="number" class="tempoCD" name="tempoCD">

  <label>Valor</label>
  <input type="text" class="valorProduto" name="valorCD">
</div>

<!-- CAMPOS DE DVD -->
<div class="camposDVD" style="display:none;">
  <label>Armazenamento</label>
  <input type="text" class="armazenamentoDVD" name="armazenamentoDVD">

  <label>Tempo de Vídeo (minutos)</label>
  <input type="number" class="tempoDVD" name="tempoDVD">

  <label>Valor</label>
  <input type="text" class="valorProduto" name="valorDVD">
</div>

    <button type="button" class="removeProduto">Remover</button>
    <hr>
  `;

  // Lógica para mostrar campos corretos
  const tipoSelect = box.querySelector(".tipoProduto");
  tipoSelect.addEventListener("change", () => {
    box.querySelector(".camposLivro").style.display = tipoSelect.value === "livro" ? "block" : "none";
    box.querySelector(".camposCD").style.display = tipoSelect.value === "cd" ? "block" : "none";
    box.querySelector(".camposDVD").style.display = tipoSelect.value === "dvd" ? "block" : "none";
  });

  // Remover produto
  box.querySelector(".removeProduto").addEventListener("click", () => box.remove());

  produtosContainer.appendChild(box);
}

addProdutoBtn.addEventListener("click", criarProdutoBox);

document.getElementById("formCadastro").addEventListener("submit", async (e) => {
  e.preventDefault();

  const autor = {
    nome_aut: document.getElementById("nome_aut").value,
    cpf_aut: document.getElementById("cpf_aut").value,
    datanascimento_aut: document.getElementById("datanascimento_aut").value
  };

  const autorRes = await fetch("http://localhost:3000/autor", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(autor)
  });

  const autorData = await autorRes.json();
  if (!autorData[0] || !autorData[0].id_aut) {
    alert("Erro ao cadastrar autor!");
    return;
  }
  const aut_id = autorData[0].id_aut;

  // Cadastro de produtos
  const boxes = produtosContainer.querySelectorAll(".produto-box");
  for (const box of boxes) {
    const tipo = box.querySelector(".tipoProduto").value;
    const titulo = box.querySelector(".tituloProduto").value;
    let bodyData = { aut_id, titulo, valor: box.querySelector(".valorProduto")?.value || 0 };

    if (tipo === "livro") {
      bodyData = {
        aut_id,
        titulo_liv: titulo,
        generoliterario_liv: box.querySelector(".generoLivro").value,
        numeropaginas_liv: box.querySelector(".paginasLivro").value,
        valor_liv: box.querySelector(".valorProduto").value
      };
      await fetch("http://localhost:3000/livro", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(bodyData) });
    } else if (tipo === "cd") {
      bodyData = {
        aut_id,
        titulo_cds: titulo,
        armazenamentocds: box.querySelector(".armazenamentoCD").value,
        tempodevideo_cds: box.querySelector(".tempoCD").value,
        valor: box.querySelector(".valorProduto").value
      };
      await fetch("http://localhost:3000/cds", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(bodyData) });
    } else if (tipo === "dvd") {
      bodyData = {
        aut_id,
        titulo_dvd: titulo,
        armazenamentodvd: box.querySelector(".armazenamentoDVD").value,
        tempodevideo_dvd: box.querySelector(".tempoDVD").value,
        valor: box.querySelector(".valorProduto").value
      };
      await fetch("http://localhost:3000/dvds", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(bodyData) });
    }
  }

  document.getElementById("msg").innerText = "Cadastro realizado com sucesso!";
  document.getElementById("formCadastro").reset();
  produtosContainer.innerHTML = "";
});

const cpfInput = document.getElementById("cpf_aut");

cpfInput.addEventListener("input", function (e) {
    let v = e.target.value;

    // remove tudo que não for número
    v = v.replace(/\D/g, "");

    // limita a 11 dígitos
    v = v.slice(0, 11);

    e.target.value = v;
});

const valorInputs = document.querySelectorAll(".valorProduto");

valorInputs.forEach(input => {
    input.addEventListener("input", function(e) {
        let v = e.target.value;

        // Remove tudo que não for número
        v = v.replace(/\D/g, "");

        // Adiciona zeros à esquerda se necessário
        while (v.length < 3) {
            v = "0" + v;
        }

        // Coloca a vírgula antes dos 2 últimos dígitos
        let inteiro = v.slice(0, -2);
        let centavos = v.slice(-2);

        // Formata com ponto a cada 3 dígitos (opcional)
        inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

        e.target.value = inteiro + "," + centavos;
    });
});


</script>
</body>
</html>
